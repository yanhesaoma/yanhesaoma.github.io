<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>盒天下注册</title>
  <style>
    /* 基础样式 */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f8f8f8;
      color: #333;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }

    .title {
      text-align: center;
      font-size: 24px;
      margin: 30px 0 40px;
      color: #333;
      font-weight: 600;
    }

    .form-container {
      background-color: #fff;
      border-radius: 10px;
      padding: 25px 20px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .form-item {
      margin-bottom: 20px;
      position: relative;
    }

    .form-item input {
      width: 100%;
      height: 50px;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 0 15px;
      box-sizing: border-box;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    .form-item input:focus {
      border-color: #17a0ee;
      outline: none;
      box-shadow: 0 0 0 2px rgba(23, 160, 238, 0.1);
    }

    /* 优化验证码输入框显示 - 增强边界清晰度 */
    .verification-code {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .verification-code input {
      width: 60%;
      /* 增强边框清晰度 */
      border: 1px solid #ccc;
      /* 增加内边距让文字更居中 */
      padding: 0 18px;
      /* 提高字体清晰度 */
      font-size: 16px;
      letter-spacing: 1px;
    }

    .verification-code input:focus {
      /* 聚焦时边框更明显 */
      border-color: #17a0ee;
      box-shadow: 0 0 0 2px rgba(23, 160, 238, 0.2);
    }

    .verification-code button {
      width: 40%;
      height: 50px;
      background-color: #f2f2f2;
      border: none;
      border-radius: 8px;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .verification-code button:hover:not(:disabled) {
      background-color: #e8e8e8;
    }

    .verification-code button:disabled {
      background-color: #e5e5e5;
      color: #999;
      cursor: not-allowed;
    }

    .agreement {
      display: flex;
      align-items: flex-start;
      margin-bottom: 25px;
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }

    .agreement input {
      margin-right: 8px;
      margin-top: 2px;
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .agreement a {
      color: #17a0ee;
      text-decoration: none;
    }

    .register-btn {
      width: 100%;
      height: 50px;
      background: linear-gradient(90deg, #17d5c9 0%, #17a0ee 100%);
      border: none;
      border-radius: 25px;
      color: #fff;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .register-btn:hover {
      opacity: 0.9;
    }

    .register-btn:active {
      opacity: 0.8;
    }

    .beian-info {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #999;
      margin-bottom: 20px;
    }

    /* 图形验证码弹窗样式 */
    .verify-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      backdrop-filter: blur(3px);
    }

    .verify-container {
      width: 85%;
      max-width: 320px;
      background-color: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
    }

    .verify-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }

    .verify-header span:first-child {
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .close-btn {
      font-size: 22px;
      cursor: pointer;
      color: #999;
      transition: color 0.2s;
      line-height: 1;
    }

    .close-btn:hover {
      color: #333;
    }

    .verify-content {
      padding: 20px;
    }

    .verify-image-container {
      position: relative;
      margin-bottom: 18px;
      height: 48px;
    }

    .verify-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: 1px solid #eee;
      border-radius: 6px;
    }

    .refresh-btn {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.8);
      border: none;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: background-color 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 1);
    }

    .verify-input-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .verify-input-container input {
      width: 65%;
      height: 44px;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 0 12px;
      font-size: 14px;
    }

    .submit-btn {
      width: 35%;
      height: 44px;
      background: linear-gradient(90deg, #17d5c9 0%, #17a0ee 100%);
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: opacity 0.2s;
    }

    .submit-btn:hover {
      opacity: 0.9;
    }

    .app_text {
      color: #17a0ee;
    }

    /* 下载APP弹窗样式 */
    .download-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      backdrop-filter: blur(3px);
    }

    .download-container {
      width: 85%;
      max-width: 350px;
      background-color: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
    }

    .download-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }

    .download-header span:first-child {
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .download-content {
      padding: 25px 20px;
      text-align: center;
    }

    .app-info {
      margin-bottom: 25px;
    }

    .app-info h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    .download-btns {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .download-btn {
      flex: 1;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 23px;
      color: #fff;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .download-btn:hover {
      opacity: 0.9;
    }

    .android-btn {
      background: linear-gradient(90deg, #17d5c9 0%, #17a0ee 100%);
    }

    .ios-btn {
      background: linear-gradient(90deg, #17a0ee 0%, #0d6efd 100%);
    }

    /* Loading 弹窗样式 */
    .loading-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      backdrop-filter: blur(2px);
    }

    .loading-container {
      background-color: #fff;
      padding: 25px 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      min-width: 120px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 15px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #17a0ee;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-container p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }

    /* 响应式调整 */
    @media (max-width: 375px) {
      .title {
        font-size: 22px;
        margin: 25px 0 30px;
      }
      
      .form-container {
        padding: 20px 15px;
      }
      
      .form-item {
        margin-bottom: 15px;
      }
      
      .form-item input,
      .verification-code button {
        height: 46px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="title">盒天下注册</h1>
    <div class="form-container">
      <div class="form-item">
        <input type="tel" id="phone" placeholder="请输入手机号" maxlength="11" />
      </div>
      <div class="form-item verification-code">
        <input type="text" id="code" placeholder="请输入验证码" maxlength="6" />
        <button id="getCodeBtn" onclick="showVerifyPopup()">获取验证码</button>
      </div>
      <!-- 内置邀请码（将通过JS随机分配） -->
      <input type="hidden" id="inviteCode" value="" />
      <div class="form-item">
        <input type="password" id="password" placeholder="请设置密码（6-20位字母和数字组合）" />
      </div>
      <div class="form-item">
        <input type="password" id="confirmPassword" placeholder="请确认密码" />
      </div>
      <div class="agreement">
        <input type="checkbox" id="agree" checked />
        <label for="agree">我已阅读并同意
          <a href="javascript:void(0)" onclick="showAgreement()" class="app_text">《用户协议》</a>
          和
          <a class="app_text" href="javascript:void(0)" onclick="showPrivacy()">《隐私政策》</a>
        </label>
      </div>
      <div class="form-item">
        <button class="register-btn" onclick="register()">立即注册</button>
      </div>
    </div>
    <div class="beian-info"></div>
  </div>

  <!-- 图形验证码弹窗 -->
  <div id="verifyPopup" class="verify-popup">
    <div class="verify-container">
      <div class="verify-header">
        <span>请完成安全验证</span>
        <span class="close-btn" onclick="closeVerifyPopup()">×</span>
      </div>
      <div class="verify-content">
        <div class="verify-image-container">
          <img id="captchaImage" src="" alt="验证码" />
          <button class="refresh-btn" onclick="refreshCaptcha()">
            <svg t="1629791314736" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M512 63.5c-247.4 0-448 200.6-448 448S264.6 959.5 512 959.5s448-200.6 448-448-200.6-448-448-448z m193.5 289.5l-81.1 81.1c-5.3-1.5-10.8-2.5-16.5-2.5-32.7 0-59.1 26.5-59.1 59.1s26.5 59.1 59.1 59.1 59.1-26.5 59.1-59.1c0-5.7-1-11.2-2.5-16.5l81.1-81.1c6.3-6.3 6.3-16.5 0-22.8-6.3-6.2-16.5-6.2-22.8 0z m-193.5 417c-143.9 0-260.8-116.9-260.8-260.8 0-108.9 67.2-202.8 162.2-242.4 13.9-5.8 29.8 0.9 35.5 14.8 5.8 13.9-0.9 29.8-14.8 35.5-74.6 31.1-124.2 103.5-124.2 185.8 0 109.8 89.2 199 199 199s199-89.2 199-199c0-82.3-49.6-154.7-124.2-185.8-13.9-5.8-20.6-21.7-14.8-35.5 5.8-13.9 21.7-20.6 35.5-14.8 95 39.6 162.2 133.5 162.2 242.4 0.2 149.2-116.7 266.1-260.6 266.1z" fill="#666"></path>
            </svg>
          </button>
        </div>
        <div class="verify-input-container">
          <input type="text" id="captchaInput" placeholder="请输入验证码" maxlength="10" />
          <button class="submit-btn" onclick="submitCaptcha()">确定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 下载APP弹窗 -->
  <div id="downloadPopup" class="download-popup">
    <div class="download-container">
      <div class="download-header">
        <span>注册成功，下载APP体验</span>
        <span class="close-btn" onclick="closeDownloadPopup()">×</span>
      </div>
      <div class="download-content">
        <div class="app-info">
          <h3>盒天下</h3>
        </div>
        <div class="download-btns" id="downloadBtns">
          <!-- 下载按钮将通过JavaScript动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <!-- Loading 弹窗 -->
  <div id="loadingPopup" class="loading-popup">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>请求处理中...</p>
    </div>
  </div>

  <script>
    // 配置信息
    const config = {
      domain: 'https://www.wdjwh.com',
      countdown: 60,
      timer: null,
      captchaId: '',
      // 邀请码列表
      inviteCodes: ['9j58SV', 'UTuiMj'],
      // 下载链接
      downloadLinks: {
        androidApk: 'https://cdn.wdjwh.com/wgt/hezi_116.apk',
        androidShare: 'https://pan.xunlei.com/s/VOWt52haUaYP70W40POU07UbA1?pwd=6zh3#',
        ios: 'https://apps.apple.com/cn/app/%E7%9B%92%E5%A4%A9%E4%B8%8Bapp/id6749471638'
      }
    };

    // 检测设备类型
    const detectDevice = () => {
      const userAgent = navigator.userAgent.toLowerCase();
      return {
        isAndroid: userAgent.includes('android'),
        isIOS: /iphone|ipad|ipod/.test(userAgent)
      };
    };

    // 生成下载按钮
    const generateDownloadButtons = () => {
      const device = detectDevice();
      const downloadBtnsContainer = document.getElementById('downloadBtns');
      downloadBtnsContainer.innerHTML = '';

      // 左侧按钮保持一致：软件下载（含新手教学）
      const leftBtn = document.createElement('a');
      leftBtn.href = config.downloadLinks.androidShare;
      leftBtn.target = '_blank';
      leftBtn.className = 'download-btn android-btn';
      leftBtn.textContent = '软件下载（含新手教学）';
      downloadBtnsContainer.appendChild(leftBtn);

      // 右侧按钮根据设备类型显示不同内容
      const rightBtn = document.createElement('a');
      rightBtn.className = device.isIOS ? 'download-btn ios-btn' : 'download-btn android-btn';
      
      if (device.isIOS) {
        // iOS设备：跳转到App Store
        rightBtn.href = config.downloadLinks.ios;
        rightBtn.target = '_blank';
        rightBtn.textContent = 'App Store下载';
      } else {
        // Android设备：复制浏览器下载链接
        rightBtn.href = 'javascript:void(0)';
        rightBtn.onclick = copyApkLink;
        rightBtn.textContent = '复制链接浏览器打开下载';
      }
      
      downloadBtnsContainer.appendChild(rightBtn);
    };

    // 页面加载初始化
    window.onload = function () {
      // 1. 随机分配邀请码（50%概率）
      const randomIndex = Math.random() >= 0.5 ? 1 : 0; // 0或1的随机索引
      document.getElementById('inviteCode').value = config.inviteCodes[randomIndex];
      
      // 2. 生成下载按钮
      generateDownloadButtons();
      
      // 3. 检查是否需要显示下载弹窗（新用户且间隔2秒以上）
      checkDownloadPopup();
    };

    // 检查是否显示下载弹窗（缓存逻辑）
    const checkDownloadPopup = () => {
      const isNewUser = localStorage.getItem('isNewUser') === 'true';
      const lastPopupTime = localStorage.getItem('lastPopupTime') || 0;
      const now = Date.now();
      
      // 新用户且距离上次弹窗超过2秒
      if (isNewUser && (now - lastPopupTime > 2000)) {
        setTimeout(() => {
          showDownloadPopup();
          localStorage.setItem('lastPopupTime', now.toString());
        }, 500); // 延迟500ms显示，提升体验
      }
    };

    // 复制APK链接
    const copyApkLink = () => {
      const apkUrl = config.downloadLinks.androidApk;
      navigator.clipboard.writeText(apkUrl).then(() => {
        alert('安装链接已复制，请在浏览器中打开粘贴该链接进行安装');
      }).catch(err => {
        console.error('复制失败:', err);
        alert('复制失败，请手动复制链接: ' + apkUrl);
      });
    };

    // 显示图形验证码弹窗
    const showVerifyPopup = () => {
      const phone = document.getElementById('phone').value;
      if (!isMobile(phone)) {
        return;
      }

      // 检查倒计时状态
      if (config.countdown > 0 && config.countdown < 60) {
        return;
      }

      // 刷新验证码并显示弹窗
      refreshCaptcha();
      document.getElementById('verifyPopup').style.display = 'flex';
    };

    // 关闭图形验证码弹窗
    const closeVerifyPopup = () => {
      document.getElementById('verifyPopup').style.display = 'none';
      document.getElementById('captchaInput').value = '';
    };

    // 刷新图形验证码
    const refreshCaptcha = () => {
      showLoading();
      fetch(`${config.domain}/api/system/sms_code/captcha`, {
        method: 'POST'
      })
        .then(response => {
          hideLoading();
          if (!response.ok) throw new Error('获取验证码失败');
          return response.json();
        })
        .then(res => {
          if (res.code === 0) {
            config.captchaId = res.data.captcha_id;
            document.getElementById('captchaImage').src = res.data.pic_path;
          } else {
            alert(res.msg || '获取验证码失败，请重试');
          }
        })
        .catch(error => {
          hideLoading();
          console.error('Error:', error);
          alert('获取验证码失败，请稍后重试');
        });
    };

    // 提交图形验证码（验证通过后获取短信验证码）
    const submitCaptcha = () => {
      const captchaInput = document.getElementById('captchaInput').value.trim();
      if (!captchaInput) {
        alert('请输入图形验证码');
        return;
      }

      const phone = document.getElementById('phone').value.trim();
      showLoading();

      // 验证图形验证码并发送短信验证码
      fetch(`${config.domain}/api/system/sms_code/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mobile: phone,
          type: 1,
          captcha_id: config.captchaId,
          captcha: captchaInput
        })
      })
        .then(response => {
          hideLoading();
          if (!response.ok) throw new Error('发送短信失败');
          return response.json();
        })
        .then(res => {
          if (res.code === 0) {
            closeVerifyPopup();
            startCountdown();
            alert('短信验证码已发送，请注意查收');
            // 自动聚焦到验证码输入框
            document.getElementById('code').focus();
          } else {
            alert(res.msg || '发送验证码失败，请重试');
            refreshCaptcha(); // 刷新验证码
          }
        })
        .catch(error => {
          hideLoading();
          console.error('Error:', error);
          alert('发送验证码失败，请稍后重试');
        });
    };

    // 验证手机号格式
    const isMobile = (mobile) => {
      const reg = /^1[3-9]\d{9}$/;
      if (!mobile) {
        alert('请输入手机号');
        return false;
      }
      if (!reg.test(mobile)) {
        alert('请输入正确的手机号');
        return false;
      }
      return true;
    };

    // 验证码倒计时
    const startCountdown = () => {
      const getCodeBtn = document.getElementById('getCodeBtn');
      getCodeBtn.disabled = true;
      config.countdown = 60;
      getCodeBtn.innerText = `重新获取(${config.countdown}s)`;

      if (config.timer) clearInterval(config.timer);
      
      config.timer = setInterval(() => {
        config.countdown--;
        getCodeBtn.innerText = `重新获取(${config.countdown}s)`;
        
        if (config.countdown <= 0) {
          clearInterval(config.timer);
          getCodeBtn.disabled = false;
          getCodeBtn.innerText = '获取验证码';
          config.countdown = 60;
        }
      }, 1000);
    };

    // 注册提交
    const register = () => {
      const phone = document.getElementById('phone').value.trim();
      const code = document.getElementById('code').value.trim();
      const inviteCode = document.getElementById('inviteCode').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const agree = document.getElementById('agree').checked;

      // 表单验证
      if (!isMobile(phone)) return;
      
      if (!code || !/^\d{6}$/.test(code)) {
        alert('请输入6位数字验证码');
        document.getElementById('code').focus();
        return;
      }
      
      if (!password || password.length < 6 || password.length > 20) {
        alert('密码长度应为6-20位');
        document.getElementById('password').focus();
        return;
      }
      
      if (!/^[a-zA-Z0-9]+$/.test(password)) {
        alert('密码只能包含字母和数字');
        document.getElementById('password').focus();
        return;
      }
      
      if (password !== confirmPassword) {
        alert('两次输入的密码不一致');
        document.getElementById('confirmPassword').focus();
        return;
      }
      
      if (!agree) {
        alert('请阅读并同意用户协议和隐私政策');
        return;
      }

      // 提交注册
      showLoading();
      fetch(`${config.domain}/api/mall/user/reg_invite`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mobile: phone,
          sms_code: code,
          invitation_code: inviteCode,
          password: password
        })
      })
        .then(response => {
          hideLoading();
          if (!response.ok) throw new Error('注册失败');
          return response.json();
        })
        .then(res => {
          if (res.code === 0) {
            // 注册成功：标记为新用户并记录首次弹窗时间
            localStorage.setItem('isNewUser', 'true');
            localStorage.setItem('lastPopupTime', Date.now().toString());
            
            // 清空表单
            document.getElementById('phone').value = '';
            document.getElementById('code').value = '';
            document.getElementById('password').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // 重置验证码按钮
            if (config.timer) {
              clearInterval(config.timer);
              const getCodeBtn = document.getElementById('getCodeBtn');
              getCodeBtn.disabled = false;
              getCodeBtn.innerText = '获取验证码';
              config.countdown = 60;
            }
            
            // 显示下载弹窗
            showDownloadPopup();
          } else {
            alert(res.msg || '注册失败，请稍后重试');
          }
        })
        .catch(error => {
          hideLoading();
          console.error('Error:', error);
          alert('注册失败，请稍后重试');
        });
    };

    // 显示用户协议
    const showAgreement = () => {
      window.location.href = 'https://www.wdjwh.com/userAgreement.html';
    };

    // 显示隐私政策
    const showPrivacy = () => {
      window.location.href = 'https://www.wdjwh.com/privacy.html';
    };

    // 显示下载APP弹窗
    const showDownloadPopup = () => {
      document.getElementById('downloadPopup').style.display = 'flex';
      // 更新最后弹窗时间
      localStorage.setItem('lastPopupTime', Date.now().toString());
    };

    // 关闭下载APP弹窗
    const closeDownloadPopup = () => {
      document.getElementById('downloadPopup').style.display = 'none';
      // 关闭时也更新时间，避免立即再次弹窗
      localStorage.setItem('lastPopupTime', Date.now().toString());
    };

    // 显示加载弹窗
    const showLoading = () => {
      document.getElementById('loadingPopup').style.display = 'flex';
    };

    // 隐藏加载弹窗
    const hideLoading = () => {
      document.getElementById('loadingPopup').style.display = 'none';
    };
  </script>
</body>
</html>
